<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>File API test</title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.10.0.css">
</head>
<body>
<div>Usage: run http-server in a client dir and go to http://localhost:8080/test/chrome/FileAPITests.html.
    File API in Chrome doesn't work with a file protocol by default (you need to start chrome with a special flag).
    To overcome this you can run the tests with the http protocol.
</div>
<div id="qunit"></div>
<div id="qunit-fixture">

</div>
<script src="http://code.jquery.com/qunit/qunit-1.10.0.js"></script>
<script src="https://raw.github.com/kriskowal/q/master/q.min.js"></script>
<script src="../../js/FileAPI.js"></script>
<script src="../../js/lib/zepto.js"></script>
<script src="../../js/download.js"></script>
<script>

    function randomFileName() {
        return "File" + Math.random();
    }

    function fileAPI() {
        return new schibsted.FileAPI({persistence:window.PERSISTENT, quota:5 * 1024 * 1024});
    }

    function download(config) {
        return schibsted.download.makeRequest(config);
    }

    function write(config) {
        return function (xhr) {
            return fileAPI().writeFile({
                name:config.name,
                content: config.content || (xhr && xhr.response),
                type:'text/plain',
                overwrite:config.overwrite
            });
        }
    }

    function readText(fileName) {
        return function () {
            return fileAPI().readFileText({
                name:fileName
            });
        }
    }

    function readDataURI(fileName) {
        return function () {
            return fileAPI().readFileDataURL({
                name:fileName
            });
        }
    }

    function assertTextContent(content) {
        return function (fileContent) {
            equal(fileContent, content, 'File read success');
            start();
        }
    }

    function assertDatURLContentContains(text) {
        return function (fileContent) {
            ok(fileContent.indexOf(text) != -1, 'File read success');
            console.log(fileContent);
            start();
        }
    }

    function fail(msg) {
        return function (e) {
            ok(false, msg + ": " + e);
            start();
        }
    }

    function expect(msg) {
        return function(e) {
            equal(e.message, msg, 'Expected error message is correct');
            start();
        }
    }

    asyncTest("Should write file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(readText(fileName), fail('write failed')).
                then(assertTextContent("a"), fail('read failed'));
    });


    asyncTest("Should overwrite file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b", overwrite:true}), fail('first write failed')).
                then(readText(fileName, "b"), fail('second write failed')).
                then(assertTextContent("b"), fail('read failed'));
    });

    asyncTest("Should overwrite file content by default", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b"}), fail('first write failed')).
                then(readText(fileName), fail('second write failed')).
                then(assertTextContent("b"), fail('read failed'));
    });

    asyncTest("Should append file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b", overwrite:false}), fail('first write failed')).
                then(readText(fileName), fail('second write failed')).
                then(assertTextContent("ab"), fail('read failed'));
    });


    asyncTest("Should save image", 1, function () {
        var fileName = randomFileName();
        download({url:'image.png', dataType:'blob'}).
                then(write({name:fileName, type:'image/png'}), fail('download failed')).
                then(readDataURI(fileName), fail('write failed')).
                then(assertDatURLContentContains("base64"), fail('read failed'));
    });


    asyncTest('Should report error when reading nonexistant file', 1, function() {
        var fileName = randomFileName();
        readText(fileName)().then(fail("unexpected file exists"), expect("NOT_FOUND_ERR"));
    });


    // TODO : save image, save video, quota exceeded, file not found, security fail, invalid modification,
    // invalid state, unknown fail, errors when requesting file, errors when creating a writer, fail when reading
    // invalid content type
</script>
</body>
</html>
