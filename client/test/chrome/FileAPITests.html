<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Actions test</title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.10.0.css">
</head>
<body>
<div>Usage: run http-server in a client dir and go to http://localhost:8080/test/chrome/FileAPITests.html.
File API in Chrome doesn't work with a file protocol by default (you need to start chrome with a special flag).
To overcome this you can run the tests with the http protocol.</div>
<div id="qunit"></div>
<div id="qunit-fixture">

</div>
<script src="http://code.jquery.com/qunit/qunit-1.10.0.js"></script>
<script src="../../FileAPI/FileAPI.js"></script>
<script>
    /**
     * Sample config:
     *
     * config = {
     *     persistence: window.PERSISTENT,
     *     overwrite: true,
     *     name: someFile.txt,
     * }
     *
     */
    function testReadAndWrite(config) {
        var fileAPI = new schibsted.FileAPI({persistence:config.persistence, quota:5 * 1024 * 1024});

        function fileRead(file) {
            equal(file.name, config.name, 'Retrieved file name is correct');
        }

        function fileWriteSuccess() {
            fileAPI.readFile({
                name:config.name,
                onSuccess:fileReadSuccess,
                onError:fileReadError
            });
        }

        function fileWriteFailure() {
            ok(false, "File write failure");
            start();
        }

        function fileReadSuccess(fileContent) {
            equal(fileContent, 'file content', 'File read success');
            start();
        }

        function fileReadError() {
            ok(false, 'File read error');
            start();
        }

        fileAPI.writeFile({
            name:config.name,
            content:'file content',
            type:'text/plain',
            overwrite: config.overwrite || false,
            onSuccess:fileWriteSuccess,
            onError: fileWriteFailure
        });


    }

    function randomFileName() {
        return "File"+Math.random();
    }

    asyncTest("Can store and retrieve files in temporary mode", 1, function() {
        testReadAndWrite({name: randomFileName(), persistence: window.TEMPORARY});
    });

    asyncTest("Can store and retrieve files in persistent mode", 1, function() {
        testReadAndWrite({name: randomFileName(), persistence: window.PERSISTENT});
    });

    asyncTest("Should overwrite file content", 2, function() {
        var fileName = randomFileName();
        testReadAndWrite({name: fileName, persistence: window.PERSISTENT, overwrite: true});
        testReadAndWrite({name: fileName, persistence: window.PERSISTENT, overwrite: true});
    });

</script>
</body>
</html>
