<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>File API test</title>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.10.0.css">
</head>
<body>
<div>Usage: run http-server in a client dir and go to http://localhost:8080/test/chrome/FileAPITests.html.
    File API in Chrome doesn't work with a file protocol by default (you need to start chrome with a special flag).
    To overcome this you can run the tests with the http protocol.
</div>
<div id="qunit"></div>
<div id="qunit-fixture">

</div>
<script src="http://code.jquery.com/qunit/qunit-1.10.0.js"></script>
<script src="https://raw.github.com/kriskowal/q/master/q.min.js"></script>
<script src="../../FileAPI/FileAPI.js"></script>
<script>

    function randomFileName() {
        return "File" + Math.random();
    }

    function fileAPI() {
        return new schibsted.FileAPI({persistence:window.PERSISTENT, quota:5 * 1024 * 1024});
    }

    function write(config) {
        return function() {
            return fileAPI().writeFile({
                name:config.name,
                content:config.content,
                type:'text/plain',
                overwrite:config.overwrite
            });
        }
    }

    function assertContent(name, content) {
        return function() {
            return fileAPI().readFile({
                name:name
            }).then(function (fileContent) {
                        equal(fileContent, content, 'File read success');
                    });
        };
    }

    function assertContentLength(name, contentLength) {
        return function() {
            return fileAPI().readFile({
                name:name
            }).then(function (fileContent) {
                        equal(fileContent.length, contentLength, 'File read success');
                    });
        };
    }

    function error(msg) {
        return function(e) {
            ok(false, msg + ": " + e);
        }
    }

    asyncTest("Should write file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(assertContent(fileName, "a"), error('write failed')).
                then(start, start);
    });


    asyncTest("Should overwrite file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b", overwrite:true}), error('first write failed')).
                then(assertContent(fileName, "b"), error('second write failed')).
                then(start, start);
    });

    asyncTest("Should overwrite file content by default", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b"}), error('first write failed')).
                then(assertContent(fileName, "b"), error('second write failed')).
                then(start, start);
    });

    asyncTest("Should append file content", 1, function () {
        var fileName = randomFileName();
        write({name:fileName, content:"a"})().
                then(write({name:fileName, content:"b", overwrite:false}), error('first write failed')).
                then(assertContent(fileName, "ab"), error('second write failed')).
                then(start, start);
    });


//    asyncTest("Should save image", 1, function () {
//        var xhr = new XMLHttpRequest();
//        xhr.open('GET', 'image.png', true);
//        xhr.responseType = 'blob';
//
//        xhr.onload = function(e) {
//            if (this.status == 200) {
//                var fileName = randomFileName();
//                var responseSize = this.response.size;
//                write({name:fileName, content: this.response, type: 'image/png'})().
//                        then(assertContentLength(fileName, responseSize), error('write failed')).
//                        then(start, start);
//            }
//        };
//
//        xhr.send();
//
//    });


    // TODO : save image, save video, quota exceeded, file not found, security error, invalid modification,
    // invalid state, unknown error, errors when requesting file, errors when creating a writer, error when reading
    // invalid content type
</script>
</body>
</html>
